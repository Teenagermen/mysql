<?php
/**
 * mysql option class file
 *
 * Copyright (c) 2011, Uoojee Corp. 
 * All rights reserved.
 *
 * PHP version 5
 *
 * @category CORE
 * @package  CORE
 * @author   Jason <bieru52@aliyun.com>
 * @version  1.0  
 * @license  Software Distribution
 * @link     http://dreameng.blog.51cto.com/
 */
class mysqlClass {
	private $host;  //数据库主机
	private $user;  //数据库用户名
	private $pwd;   //数据库密码
	private $db;    //数据库名称
	private $charset;  //数据库字符集
	private $db_connect_type;  //数据库连接状态 永久连接、即时连接
	private $is_show_error = false; //是否显示错误  默认不显示
	private $is_show_run_tim = false;  //是否显示运行时间  默认不显示

	private $connection;
	//排序方式
	private $sortArr = array(
		'ASC', 'DESC' 
	);
			 
	function __construct($host, $user, $pwd, $db, $charset='utf8', $db_connect_type='npc') {
		$this -> host = $host;
		$this -> user = $user;
		$this -> pwd  = $pwd;
		$this -> db   = $db;
		$this -> charset = empty($charset) ? 'utf8' : $charset;
		$this -> db_connect_type = empty($db_connect_type) ? 'npc' : $db_connect_type; 
	}
	/**
	 * 数据库连接并设置编码
	 * 
	 * @return void
	 */
	public function connect() {
		if ($this -> db_connect_type == 'pconnect') {
			$this -> connection = mysql_pconnect($this -> host, $this -> user, $this -> pwd);
		} else {
			$this -> connection = mysql_connect($this -> host, $this -> user, $this -> pwd);
		}

		if (!mysql_select_db($this->db, $this->connection)) {
			if ($this -> is_show_error) {
				$this -> showError("the database connect is wrong", $this->db);
				mysql_close($this->connection);	
			}

		}

		mysql_query("set names ".$this->charset);
	}
	/**
	 * 插入数据
	 * 
	 * @param string  $table  数据表名称
	 * @param array   $values 插入的数据的值 比如：array('name'=>'zhl', 'age'=>'25');
	 * @param boolean $bool 标识返回值默认是返回true | false，如果boole=true返回插入的Id
	 * 
	 * @return mixed (boolean | int)
	 */
	public function insert($table, $values, $bool = false) {
		if (empty($table) || !is_array($values) || empty($values) ) {
			return false;
		}

		$tmpFields = array();
		$tmpValues = array();

		foreach ($values as $field => $val) {
			$tmpFields[] = '`'. htmlspecialchars($field).'`';
			$tmpValues[] = $this->_sqlInjectionAttack($val);
		}

		$strField = implode(', ', $tmpFields);
		$strValue = implode(', ', $tmpValues);

		$sql = sprintf(
			'INSERT INTO `%s` (%s) VALUES (%s)',
				$this->_sqlInjectionAttack($table, true),
				$strField,
				$strValue
			);

		if ($bool) {
			$this->query($sql);
			return $this->getPrevId();
		} else {
			return $this->query($sql);
		}

	}
	/**
	 * 获取上次插入数据的ID
	 * 
	 * @return integer
	 */
	public function getPrevId() {
		return mysql_insert_id();
	}
	/**
	 * [delete description]
	 * @param  [type] $table     [description]
	 * @param  array  $condition [description]
	 * @return [type]            [description]
	 */
	public function delete($table, $condition=array()) {
		if (empty($table)) {
			return false;
		}

		$condition = $this->_combinCond($condition);
		if (empty($condition)) {
			$sql = sprintf(
				'DELETE FROM `%s`',
				$this->_sqlInjectionAttack($table, true)
			);
		} else {
			$con = implode(' AND ', $condition);
			$sql = sprintf(
				'DELETE FROM `%s` WHERE %s',
				$this->_sqlInjectionAttack($table, true),
				$con
			);
		}

		return $this->query($sql);

	}
	/**
	 * 修改数据的值
	 * 
	 * @param string $table     数据表名
	 * @param array  $values    需要修改的值forexample:array('name'=>'zhl')
	 * @param array  $condition 修改数据的条件 forexample:array('eq' => array('name'=>'gavin'));
	 * 
	 * @return boolean
	 */
	public function modify($table, $values, $condition=array()) {
		if (empty($table) || !is_array($values) || empty($values)) {
			return false;
		}
		$tmpArr = array();
		foreach ($values as $field => $val) {
			$tmpArr[] = '`'.$this->_sqlInjectionAttack($field, true).'` = '.$this->_sqlInjectionAttack($val);
		}

		$tmpStr = implode(', ', $tmpArr);
		$con = $this->_combinCond($condition);
		if (empty($con)) {
			$sql = sprintf(
				'UPDATE `%s` SET %s',
				$this->_sqlInjectionAttack($table, true),
				$tmpStr
				);
		} else {
			$cond = implode(', ', $con);
			$sql = sprintf(
				'UPDATE `%s` SET %s WHERE %s',
				$this->_sqlInjectionAttack($table, true),
				$tmpStr,
				$cond
				);
		}

		return $this->query($sql);
	}
	/**
	 * 查询数据
	 * 
	 * @param  string  $table     数据表名
	 * @param  array   $fields    需要获取的字段名称 forexample:array('title', 'content');
	 * @param  array   $condition 查询数据的条件 forexample:array('eq'=>array('group_id'=>3));
	 * @param  string  $order     排序字段
	 * @param  string  $sort      排序的方式
	 * @param  integer $limit     获取数据的数量
	 * @param  boolean $bool      获取数据是关联下标还是数字
	 * 
	 * @return array
	 */
	public function find($table, $fields = array(), $condition=array(), $order='id', $sort='DESC', $limit=0, $bool=false) {
		$datas = array();
		$sql = $this->_combinSql($table, $fields, $condition, $order, $sort, $limit);
		$result = $this->query($sql);
		if ($bool) {
			while ($row = mysql_fetch_assoc($result)) {
				$datas[] = $row;
			}
		} else {
			while ($row = mysql_fetch_row($result)) {
				$datas[] = $row;
			}
		}
		return $datas;
	}
	/**
	 * 获取一条数据
	 * 
	 * @param  string  $table     数据表名
	 * @param  array   $fields    需要获取的字段名称 forexample:array('title', 'content');
	 * @param  array   $condition 查询数据的条件 forexample:array('eq'=>array('group_id'=>3));
	 * @param  boolean $bool      获取数据是关联下标还是数字
	 * 
	 * @return array
	 */
	public function findOne($table, $fields=array(), $condition=array(), $bool=false) {
		$sql = $this->_combinSql($table, $fields, $condition);
		$result = $this->query($sql);
		if ($bool) {
			$datas = mysql_fetch_assoc($result);
		} else {
			$datas = mysql_fetch_row($result);
		}

		return $datas;
	}
	/**
	 * 获取数据的条数
	 * 
	 * @param  [type] $table     数据表名
	 * @param  array  $fields    需要获取的字段名字，默认是数组，array('id', 'name')
	 * @param  array  $condition 获取的数据的条件
	 * @param  string $groupby   分组条件
	 * 
	 * @return array
	 * 
	 * 优化总结，对于MyISAM表来说：
	 * 任何情况下SELECT COUNT(*) FROM tablename是最优选择；
	 * 尽量减少SELECT COUNT(*) FROM tablename WHERE COL = 'value' 这种查询；
	 * 杜绝SELECT COUNT(COL) FROM tablename WHERE COL2 = 'value' 的出现。
	 */
	public function count($table, $fields=array(), $condition=array(), $groupby='') {
		if (empty($table)) {
			return array();
		}

		$strFields = '';
		if (!empty($fields)) {
			foreach ($fields as $field) {
				$tmpArrs[] = '`'.$this->_sqlInjectionAttack($field, true).'`';
			}
			$strFields = implode(', ', $tmpArrs);
		}
		$con = $this->_combinCond($condition);
		$sqlGroup = '';
		if (!empty($groupby)) {
			$sqlGroup = 'GROUP BY `'.$this->_sqlInjectionAttack($groupby, true).'`';
		}
		if (!empty($con)) {
			$cond = implode(', ', $con);
			if ($strFields) {
				$sql = sprintf(
					'SELECT %s, COUNT(*) FROM %s WHERE %s %s',
					$strFields,
					$this->_sqlInjectionAttack($table, true),
					$cond,
					$sqlGroup
				);
			} else {
				$sql = sprintf(
					'SELECT COUNT(*) FROM %s WHERE %s %s',
					$this->_sqlInjectionAttack($table, true),
					$cond,
					$sqlGroup
				);
			}
		} else {
			if ($strFields) {
				$sql = sprintf(
					'SELECT %s, COUNT(*) FROM `%s` %s',
					$strFields,
					$this->_sqlInjectionAttack($table, true),
					$sqlGroup
				);
			} else {
				$sql = sprintf(
					'SELECT COUNT(*) FROM `%s` %s',
					$this->_sqlInjectionAttack($table, true),
					$sqlGroup
				);
			}
		}

		$result = $this->query($sql);
		return mysql_fetch_row($result);
	}
	/**
	 * 执行sql语句
	 * 
	 * @param string $sql 执行的sql语句
	 * 
	 * @return mixed
	 */
	public function query($sql) {
		if ($this->is_show_run_tim) {
			$starTime = microtime(true);
			$result = mysql_query($sql, $this->connection);
			$endTime = microtime(true);
			echo "<br />执行的SQL:$sql<br />开始时间：$starTime    结束时间:endTime<br />花费的时间是：".$starTime-$endTime." MS<br />";
		} else {
			$result = mysql_query($sql, $this->connection);
		}

		if (!$result) {
			if ($this->is_show_error) {
				$this->showError("SQL执行错误：".$sql);
			}
			return false;
		} else {
			return $result;
		}
	}

	public function showError($mess='', $sql='') {
		echo mysql_error();
		die;
	}
	/**
	 * 关闭数据库连接
	 * 
	 * @return void
	 */
	public function __destruct() {
		if (!empty($this->result)) {
			$this->mysql_free_result();
		}
		@mysql_close($this->connection);
	}
	/**
	 * 组合sql语句的条件
	 * 
	 * @param array $condition 数据操作的条件
	 * 
	 * @return array
	 */
	private function _combinCond($condition) {
		$cond = array();
		if (!is_array($condition) || empty($condition)) {
			return $cond;
		} 

		foreach ($condition as $key => $vals) {
			if (!is_array($vals)) {
				continue;
			}
			$key = strtolower($key);
			foreach ($vals as $field => $val) {
				if ($key == 'eq') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` = '.$this->_sqlInjectionAttack($val); 
				} else if ($key == 'like') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` like \'%'.$this->_sqlInjectionAttack($val, true).'%\''; 
				} else if ($key == 'in') {
					if (is_array($val) && !empty($val)) {
						$tmpVal = array();
						foreach ($val as $v) {
							$tmpVal[] = $this->_sqlInjectionAttack($v, true);
						}
						$tmpStrVal = implode(',', $tmpVal);
						$cond[] = "`".$this->_sqlInjectionAttack($field, true).'` in ('.$tmpStrVal.')';
					}
				} else if ($key == '>' || $key == 'gt') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` >'. $this->_sqlInjectionAttack($val);
				} else if ($key == '>=' || $key == 'gte') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` >='. $this->_sqlInjectionAttack($val);
				} else if ($key == '<' || $key == 'lt') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` < '. $this->_sqlInjectionAttack($val);
				} else if ($key == '<=' || $key == 'lte') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` <= '. $this->_sqlInjectionAttack($val);
				} else if ($key == '!=' || $key == 'neq') {
					$cond[] = "`".$this->_sqlInjectionAttack($field, true) .'` != '. $this->_sqlInjectionAttack($val);
				}
			}
		}

		return $cond;
	}
	/**
	 * 拼装sql语句
	 * 
	 * @param string  $table     数据表名
	 * @param array   $fields    需要查询的字段
	 * @param array   $condition 查询数据条件
	 * @param string  $order     排序的字段
	 * @param string  $sort      排序的方式
	 * @param integer $limit     获取数据条数
	 * 
	 * @return string|boolean
	 */
	private function _combinSql($table, $fields = array(), $condition=array(), $order='', $sort='', $limit=0) {
		if (empty($table)) {
			return false;
		}

		$getFields = " * ";
		if (!empty($fields)) {
			foreach ($fields as $field) {
				$tmpFields[] = '`'.$this->_sqlInjectionAttack($field, true).'`';
			}
			$getFields = implode(', ', $tmpFields);
		}

		$con = $this->_combinCond($condition);
		$sqlOrder = '';
		if (!empty($order) && !empty($sort) && in_array(strtoupper($sort), $this->sortArr)) {
			$sqlOrder = ' ORDER BY `'.htmlspecialchars($order).'` '.$sort;
		}

		$sqlLimit = '';
		$limit = (int)$limit;
		if ($limit) {
			$sqlLimit = ' LIMIT '.$limit;
		}
		if (empty($con)) {
			$sql = sprintf(
				'SELECT %s FROM `%s` %s %s',
				$getFields,
				$this->_sqlInjectionAttack($table, true),
				$sqlOrder,
				$sqlLimit
			);
		} else {
			$cond = implode(' AND ', $con);
			$sql = sprintf(
				'SELECT %s FROM `%s` WHERE %s %s %s',
				$getFields,
				$this->_sqlInjectionAttack($table, true),
				$cond,
				$sqlOrder,
				$sqlLimit
			);
		}
		return $sql;

	}
	/**
	 * 防止sql注入
	 * get_magic_quotes_gpc 方法在PHP5.4中已经去掉
	 * 
	 * @param string  $value 字段的value值
	 * @param boolean $bool  标识是否使用引号， 比如在拼装sql使用like的时候不需要引号
	 * 
	 * @return mixed
	 */
	private function _sqlInjectionAttack($value, $bool=false) {
		if (empty($value)) {
			return $value;
		}

		if (!is_numeric($value)) {
			if ($bool) {
				$value = mysql_real_escape_string($value);
			} else {
				$value = "'". mysql_real_escape_string($value) ."'";	
			}
		}

		return $value;
	}
}
?>
